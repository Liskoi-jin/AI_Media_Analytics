{% extends "base.html" %}

{% block title %}文件上传 - AI媒介自动化审计分析系统{% endblock %}
{% block page_title %}文件上传{% endblock %}
{% block page_subtitle %}上传您的数据文件开始分析{% endblock %}
{% block breadcrumb %}
    <li class="breadcrumb-item active" style="color: var(--text-light);"><i class="fas fa-upload me-1"></i>文件上传</li>
{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2">
    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#uploadHelpModal">
        <i class="fas fa-question-circle me-1"></i> 帮助
    </button>
    <a href="#" class="btn btn-outline-secondary">
        <i class="fas fa-file-download me-1"></i> 下载模板
    </a>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .upload-section {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 16px;
        padding: 30px;
        margin-bottom: 30px;
        transition: var(--transition);
    }

    .upload-section:hover {
        border-color: var(--primary);
        box-shadow: 0 10px 30px rgba(99, 102, 241, 0.2);
    }

    .file-upload-card {
        background: rgba(30, 41, 59, 0.5);
        border: 2px dashed var(--card-border);
        border-radius: 12px;
        padding: 40px 20px;
        text-align: center;
        cursor: pointer;
        transition: var(--transition);
        min-height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .file-upload-card:hover,
    .file-upload-card.dragover {
        border-color: var(--primary);
        background: rgba(99, 102, 241, 0.1);
    }

    .file-upload-card i {
        font-size: 3rem;
        margin-bottom: 15px;
        color: var(--primary);
    }

    .file-list {
        margin-top: 20px;
    }

    .file-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        background: rgba(30, 41, 59, 0.3);
        border-radius: 8px;
        margin-bottom: 8px;
        border: 1px solid var(--card-border);
        transition: var(--transition);
    }

    .file-item:hover {
        background: rgba(99, 102, 241, 0.1);
        border-color: var(--primary);
    }

    .file-item-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .file-item-name {
        font-weight: 500;
    }

    .file-item-size {
        color: var(--text-gray);
        font-size: 0.85rem;
    }

    .remove-file-btn {
        background: rgba(239, 68, 68, 0.2);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: #ef4444;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
    }

    .remove-file-btn:hover {
        background: rgba(239, 68, 68, 0.3);
        transform: scale(1.1);
    }

    .form-section {
        background: rgba(30, 41, 59, 0.5);
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        border: 1px solid var(--card-border);
    }

    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--primary);
    }

    .form-label {
        font-weight: 500;
        margin-bottom: 8px;
        color: var(--text-light);
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .advanced-toggle {
        background: transparent;
        border: 1px solid var(--card-border);
        color: var(--text-light);
        padding: 8px 15px;
        border-radius: 8px;
        width: 100%;
        text-align: left;
        transition: var(--transition);
    }

    .advanced-toggle:hover {
        background: rgba(99, 102, 241, 0.1);
        border-color: var(--primary);
    }

    /* 时间选择器样式 */
    .time-selector-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .time-type-selector {
        display: flex;
        gap: 15px;
        margin-bottom: 10px;
    }

    .time-type-btn {
        flex: 1;
        padding: 10px 15px;
        background: rgba(30, 41, 59, 0.7);
        border: 2px solid var(--card-border);
        border-radius: 10px;
        color: var(--text-light);
        text-align: center;
        cursor: pointer;
        transition: var(--transition);
        font-weight: 500;
    }

    .time-type-btn:hover {
        background: rgba(99, 102, 241, 0.2);
        border-color: var(--primary);
    }

    .time-type-btn.active {
        background: rgba(99, 102, 241, 0.3);
        border-color: var(--primary);
        color: var(--primary);
        font-weight: 600;
    }

    .time-inputs {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    .time-input-group {
        flex: 1;
        min-width: 120px;
    }

    .time-input-group label {
        font-size: 0.9rem;
        color: var(--text-gray);
        margin-bottom: 5px;
        display: block;
    }

    .time-input {
        width: 100%;
        padding: 10px 15px;
        background: rgba(30, 41, 59, 0.7);
        border: 2px solid var(--card-border);
        border-radius: 10px;
        color: var(--text-light);
        transition: var(--transition);
    }

    .time-input:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }

    .time-preview {
        background: rgba(99, 102, 241, 0.1);
        border: 1px solid rgba(99, 102, 241, 0.3);
        border-radius: 10px;
        padding: 12px 15px;
        margin-top: 10px;
        font-weight: 500;
        color: var(--primary);
        text-align: center;
    }

    .time-preview .label {
        color: var(--text-gray);
        font-size: 0.9rem;
        margin-right: 8px;
    }

    /* 小组选择器样式 */
    .group-selector-container {
        margin-top: 10px;
    }

    .group-selector-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--card-border);
    }

    .group-selector-title {
        font-weight: 600;
        color: var(--text-light);
        font-size: 1rem;
    }

    .group-selector-actions {
        display: flex;
        gap: 8px;
    }

    .group-action-btn {
        padding: 4px 12px;
        background: rgba(99, 102, 241, 0.2);
        border: 1px solid rgba(99, 102, 241, 0.3);
        border-radius: 6px;
        color: var(--primary);
        font-size: 0.85rem;
        cursor: pointer;
        transition: var(--transition);
    }

    .group-action-btn:hover {
        background: rgba(99, 102, 241, 0.3);
        transform: translateY(-2px);
    }

    .group-checkbox-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 12px;
        max-height: 200px;
        overflow-y: auto;
        padding: 10px;
        background: rgba(30, 41, 59, 0.5);
        border-radius: 8px;
        border: 1px solid var(--card-border);
    }

    .group-checkbox-item {
        display: flex;
        align-items: center;
        padding: 10px;
        background: rgba(30, 41, 59, 0.3);
        border-radius: 8px;
        transition: var(--transition);
        cursor: pointer;
    }

    .group-checkbox-item:hover {
        background: rgba(99, 102, 241, 0.1);
        transform: translateX(3px);
    }

    .group-checkbox-item.selected {
        background: rgba(99, 102, 241, 0.2);
        border: 1px solid rgba(99, 102, 241, 0.4);
    }

    .group-checkbox {
        margin-right: 10px;
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: var(--primary);
    }

    .group-label {
        font-weight: 500;
        color: var(--text-light);
        cursor: pointer;
        flex: 1;
    }

    .group-count {
        background: rgba(99, 102, 241, 0.2);
        color: var(--primary);
        font-size: 0.8rem;
        font-weight: 600;
        padding: 2px 8px;
        border-radius: 10px;
        margin-left: 8px;
    }

    .selected-groups-display {
        margin-top: 15px;
        padding: 12px;
        background: rgba(99, 102, 241, 0.1);
        border-radius: 8px;
        border: 1px solid rgba(99, 102, 241, 0.2);
    }

    .selected-groups-title {
        font-size: 0.9rem;
        color: var(--text-gray);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .selected-groups-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .selected-group-tag {
        display: inline-flex;
        align-items: center;
        background: rgba(99, 102, 241, 0.2);
        color: var(--primary);
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 0.85rem;
        font-weight: 500;
        border: 1px solid rgba(99, 102, 241, 0.3);
    }

    .selected-group-tag i {
        margin-left: 6px;
        cursor: pointer;
        font-size: 0.8rem;
        opacity: 0.7;
    }

    .selected-group-tag i:hover {
        opacity: 1;
    }

    .no-groups-selected {
        color: var(--text-gray);
        font-style: italic;
        font-size: 0.9rem;
    }

    /* 新增：调整表单布局的样式 */
    .config-container {
        display: flex;
        flex-wrap: wrap;
        gap: 25px;
        margin-bottom: 20px;
    }

    .config-item {
        flex: 1;
        min-width: 300px;
        background: rgba(30, 41, 59, 0.3);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid var(--card-border);
        transition: var(--transition);
    }

    .config-item:hover {
        border-color: var(--primary);
        box-shadow: 0 5px 15px rgba(99, 102, 241, 0.1);
    }

    .config-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--card-border);
    }

    .config-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: rgba(99, 102, 241, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        color: var(--primary);
    }

    .config-title {
        font-weight: 600;
        color: var(--text-light);
        font-size: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- 上传说明卡片 -->
        <div class="upload-section fade-in">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h3 class="mb-3"><i class="fas fa-info-circle text-primary me-2"></i>上传说明</h3>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-check text-success mt-1 me-2"></i>
                                <div>
                                    <div class="fw-medium">支持格式</div>
                                    <small class="text-muted">CSV、Excel（.xlsx/.xls）</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-check text-success mt-1 me-2"></i>
                                <div>
                                    <div class="fw-medium">文件大小</div>
                                    <small class="text-muted">单个不超过50MB</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-check text-success mt-1 me-2"></i>
                                <div>
                                    <div class="fw-medium">上传方式</div>
                                    <small class="text-muted">支持批量多文件上传</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-exclamation-triangle text-warning mt-1 me-2"></i>
                                <div>
                                    <div class="fw-medium">格式要求</div>
                                    <small class="text-muted">请确保列名与模板一致</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-center">
                    <div class="icon-wrapper mx-auto mb-3" style="width: 80px; height: 80px;">
                        <i class="fas fa-cloud-upload-alt fa-2x text-primary"></i>
                    </div>
                    <h5 class="mb-2">开始您的数据分析之旅</h5>
                    <p class="text-muted small">上传数据文件，AI将为您生成详细的分析报告</p>
                </div>
            </div>
        </div>

        <!-- 上传表单 -->
        <form action="{{ url_for('index') }}" method="post" enctype="multipart/form-data" id="uploadForm">
            <!-- 分析配置部分 - 重新设计布局 -->
            <div class="form-section fade-in" style="animation-delay: 0.1s;">
                <h4 class="section-title"><i class="fas fa-cog"></i>分析配置</h4>

                <div class="config-container">
                    <!-- 分析时间配置 -->
                    <div class="config-item">
                        <div class="config-header">
                            <div class="config-icon">
                                <i class="fas fa-calendar"></i>
                            </div>
                            <div class="config-title">分析时间</div>
                        </div>

                        <div class="time-selector-container">
                            <!-- 时间类型选择 -->
                            <div class="time-type-selector">
                                <div class="time-type-btn active" data-type="week">按周</div>
                                <div class="time-type-btn" data-type="month">按月</div>
                            </div>

                            <!-- 时间输入区域 -->
                            <div class="time-inputs">
                                <!-- 年选择 -->
                                <div class="time-input-group">
                                    <label>年份</label>
                                    <select class="time-input" id="yearSelect">
                                        {% set current_year = now.year if now else 2024 %}
                                        {% for year in range(current_year-5, current_year+3) %}
                                            <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}年</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <!-- 月选择 -->
                                <div class="time-input-group">
                                    <label>月份</label>
                                    <select class="time-input" id="monthSelect">
                                        {% for month in range(1, 13) %}
                                            <option value="{{ month }}" {% if month == (now.month if now else 12) %}selected{% endif %}>{{ month }}月</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <!-- 周选择 -->
                                <div class="time-input-group week-input">
                                    <label>周数</label>
                                    <select class="time-input" id="weekSelect">
                                        {% for week in range(1, 5) %}
                                            <option value="{{ week }}" {% if week == 1 %}selected{% endif %}>第{{ week }}周</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <!-- 时间预览 -->
                            <div class="time-preview" id="timePreview">
                                <span class="label">分析时间：</span>
                                <span id="timeDisplay">{{ current_year }}年第1周</span>
                            </div>

                            <!-- 隐藏的输入字段，用于表单提交 -->
                            <input type="hidden" name="category" id="categoryInput" value="{{ current_year }}年第1周">
                            <input type="hidden" name="time_type" id="timeTypeInput" value="week">
                        </div>
                    </div>

                    <!-- 分析小组配置 -->
                    <div class="config-item">
                        <div class="config-header">
                            <div class="config-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="config-title">分析小组</div>
                        </div>

                        <div class="group-selector-container">
                            <div class="group-selector-header">
                                <div class="group-selector-title">选择分析小组</div>
                                <div class="group-selector-actions">
                                    <button type="button" class="group-action-btn" id="selectAllGroups">
                                        <i class="fas fa-check-double me-1"></i>全选
                                    </button>
                                    <button type="button" class="group-action-btn" id="clearAllGroups">
                                        <i class="fas fa-times-circle me-1"></i>清空
                                    </button>
                                </div>
                            </div>

                            <!-- 小组复选框区域 -->
                            <div class="group-checkbox-container" id="groupCheckboxContainer">
                                {% if all_groups %}
                                    {% for group in all_groups %}
                                        <div class="group-checkbox-item" data-group="{{ group }}">
                                            <input type="checkbox"
                                                   class="group-checkbox"
                                                   id="group_{{ loop.index }}"
                                                   name="selected_groups[]"
                                                   value="{{ group }}">
                                            <label class="group-label" for="group_{{ loop.index }}">{{ group }}</label>
                                            <span class="group-count">0</span>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <!-- 默认小组列表 -->
                                    <div class="group-checkbox-item" data-group="家居媒介组">
                                        <input type="checkbox"
                                               class="group-checkbox"
                                               id="group_1"
                                               name="selected_groups[]"
                                               value="家居媒介组">
                                        <label class="group-label" for="group_1">家居媒介组</label>
                                        <span class="group-count">0</span>
                                    </div>
                                    <div class="group-checkbox-item" data-group="快消媒介组">
                                        <input type="checkbox"
                                               class="group-checkbox"
                                               id="group_2"
                                               name="selected_groups[]"
                                               value="快消媒介组">
                                        <label class="group-label" for="group_2">快消媒介组</label>
                                        <span class="group-count">0</span>
                                    </div>
                                    <div class="group-checkbox-item" data-group="数码媒介组">
                                        <input type="checkbox"
                                               class="group-checkbox"
                                               id="group_3"
                                               name="selected_groups[]"
                                               value="数码媒介组">
                                        <label class="group-label" for="group_3">数码媒介组</label>
                                        <span class="group-count">0</span>
                                    </div>
                                    <div class="group-checkbox-item" data-group="电商媒介组">
                                        <input type="checkbox"
                                               class="group-checkbox"
                                               id="group_4"
                                               name="selected_groups[]"
                                               value="电商媒介组">
                                        <label class="group-label" for="group_4">电商媒介组</label>
                                        <span class="group-count">0</span>
                                    </div>
                                    <div class="group-checkbox-item" data-group="户外媒介组">
                                        <input type="checkbox"
                                               class="group-checkbox"
                                               id="group_5"
                                               name="selected_groups[]"
                                               value="户外媒介组">
                                        <label class="group-label" for="group_5">户外媒介组</label>
                                        <span class="group-count">0</span>
                                    </div>
                                {% endif %}
                            </div>

                            <!-- 已选小组显示区域 -->
                            <div class="selected-groups-display" id="selectedGroupsDisplay">
                                <div class="selected-groups-title">
                                    <i class="fas fa-check-circle text-primary"></i>
                                    已选小组 (<span id="selectedCount">0</span>个)
                                </div>
                                <div class="selected-groups-list" id="selectedGroupsList">
                                    <div class="no-groups-selected">暂未选择小组</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 文件上传区域 -->
            <div class="form-section fade-in" style="animation-delay: 0.2s;">
                <h4 class="section-title"><i class="fas fa-file-upload"></i>数据上传</h4>
                <div class="row">
                    <!-- 工作量数据 -->
                    <div class="col-md-4 mb-4">
                        <div class="card h-100 border-0" style="background: rgba(22, 93, 255, 0.1); border: 1px solid rgba(22, 93, 255, 0.2) !important;">
                            <div class="card-body">
                                <h5 class="card-title d-flex align-items-center">
                                    <div class="icon-wrapper me-2" style="background: rgba(22, 93, 255, 0.2);">
                                        <i class="fas fa-briefcase text-blue"></i>
                                    </div>
                                    工作量数据
                                </h5>
                                <p class="text-muted small mb-3">上传定档量等工作量相关数据</p>

                                <div class="file-upload-card" id="workloadDropArea">
                                    <i class="fas fa-file-excel"></i>
                                    <h6>拖拽文件到此处</h6>
                                    <p class="text-muted small">或点击选择文件</p>
                                    <input type="file" name="workload_files[]" id="workloadFiles" class="d-none" multiple accept=".csv,.xlsx,.xls">
                                </div>

                                <div class="file-list" id="workloadFileList"></div>

                                <button type="button" class="btn btn-outline-primary w-100 mt-3" onclick="document.getElementById('workloadFiles').click()">
                                    <i class="fas fa-plus me-1"></i> 选择文件
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 工作质量数据 -->
                    <div class="col-md-4 mb-4">
                        <div class="card h-100 border-0" style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2) !important;">
                            <div class="card-body">
                                <h5 class="card-title d-flex align-items-center">
                                    <div class="icon-wrapper me-2" style="background: rgba(16, 185, 129, 0.2);">
                                        <i class="fas fa-check-circle text-green"></i>
                                    </div>
                                    工作质量数据
                                </h5>
                                <p class="text-muted small mb-3">上传提报过筛率等质量数据</p>

                                <div class="file-upload-card" id="qualityDropArea">
                                    <i class="fas fa-file-excel"></i>
                                    <h6>拖拽文件到此处</h6>
                                    <p class="text-muted small">或点击选择文件</p>
                                    <input type="file" name="quality_files[]" id="qualityFiles" class="d-none" multiple accept=".csv,.xlsx,.xls">
                                </div>

                                <div class="file-list" id="qualityFileList"></div>

                                <button type="button" class="btn btn-outline-success w-100 mt-3" onclick="document.getElementById('qualityFiles').click()">
                                    <i class="fas fa-plus me-1"></i> 选择文件
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 成本数据 -->
                    <div class="col-md-4 mb-4">
                        <div class="card h-100 border-0" style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.2) !important;">
                            <div class="card-body">
                                <h5 class="card-title d-flex align-items-center">
                                    <div class="icon-wrapper me-2" style="background: rgba(245, 158, 11, 0.2);">
                                        <i class="fas fa-coins text-orange"></i>
                                    </div>
                                    成本效益数据
                                </h5>
                                <p class="text-muted small mb-3">上传CPM、返点比例等成本数据</p>

                                <div class="file-upload-card" id="costDropArea">
                                    <i class="fas fa-file-excel"></i>
                                    <h6>拖拽文件到此处</h6>
                                    <p class="text-muted small">或点击选择文件</p>
                                    <input type="file" name="cost_files[]" id="costFiles" class="d-none" multiple accept=".csv,.xlsx,.xls">
                                </div>

                                <div class="file-list" id="costFileList"></div>

                                <button type="button" class="btn btn-outline-warning w-100 mt-3" onclick="document.getElementById('costFiles').click()">
                                    <i class="fas fa-plus me-1"></i> 选择文件
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 高级配置 -->
            <div class="form-section fade-in" style="animation-delay: 0.3s;">
                <button class="advanced-toggle mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#advancedConfig">
                    <i class="fas fa-sliders-h me-2"></i> 高级配置选项
                    <i class="fas fa-angle-down float-end mt-1"></i>
                </button>

                <div class="collapse" id="advancedConfig">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-calculator me-1"></i>质量计算方式</label>
                            <div class="d-flex gap-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="use_original_state" id="useOriginal" value="true" checked>
                                    <label class="form-check-label" for="useOriginal">
                                        <i class="fas fa-history me-1"></i> 原始状态
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="use_original_state" id="useStandard" value="false">
                                    <label class="form-check-label" for="useStandard">
                                        <i class="fas fa-chart-line me-1"></i> 标准化计算
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-filter me-1"></i>成本阈值配置</label>
                            <div class="row g-2">
                                <div class="col-6">
                                    <input type="number" class="form-control form-control-advanced form-control-sm"
                                           name="cpm_good" value="50.0" step="0.1" placeholder="CPM优秀阈值">
                                </div>
                                <div class="col-6">
                                    <input type="number" class="form-control form-control-advanced form-control-sm"
                                           name="cpm_medium" value="100.0" step="0.1" placeholder="CPM一般阈值">
                                </div>
                                <div class="col-6">
                                    <input type="number" class="form-control form-control-advanced form-control-sm"
                                           name="cpe_good" value="5.0" step="0.1" placeholder="CPE优秀阈值">
                                </div>
                                <div class="col-6">
                                    <input type="number" class="form-control form-control-advanced form-control-sm"
                                           name="cpe_medium" value="10.0" step="0.1" placeholder="CPE一般阈值">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 提交按钮 -->
            <div class="text-center mt-4 fade-in" style="animation-delay: 0.4s;">
                <button type="submit" class="btn btn-advanced px-5 py-3" id="submitBtn">
                    <i class="fas fa-play-circle me-2"></i> 开始智能分析
                </button>
                <button type="reset" class="btn btn-outline-secondary px-5 py-3 ms-3" onclick="resetFileLists()">
                    <i class="fas fa-redo me-2"></i> 重置表单
                </button>
            </div>
        </form>
    </div>
</div>

<!-- 帮助模态框 -->
<div class="modal fade modal-advanced" id="uploadHelpModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-question-circle me-2"></i>上传帮助</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <h6><i class="fas fa-file-excel text-success me-2"></i>文件格式要求</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success me-2"></i>支持 .csv, .xlsx, .xls 格式</li>
                            <li><i class="fas fa-check text-success me-2"></i>建议使用UTF-8编码</li>
                            <li><i class="fas fa-check text-success me-2"></i>单文件最大50MB</li>
                        </ul>
                    </div>
                    <div class="col-md-6 mb-4">
                        <h6><i class="fas fa-columns text-primary me-2"></i>列名要求</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success me-2"></i>保持与模板一致</li>
                            <li><i class="fas fa-check text-success me-2"></i>避免特殊字符</li>
                            <li><i class="fas fa-check text-success me-2"></i>确保数据格式正确</li>
                        </ul>
                    </div>
                </div>
                <div class="alert" style="background: rgba(99, 102, 241, 0.1); border-left: 4px solid var(--primary);">
                    <i class="fas fa-lightbulb text-primary me-2"></i>
                    <strong>提示：</strong>您可以选择上传部分数据文件，系统会根据已有数据生成相应报告。建议上传完整数据以获得更全面的分析结果。
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <a href="#" class="btn btn-primary"><i class="fas fa-download me-1"></i> 下载完整模板</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let isSubmitting = false;

// 获取当前日期
function getCurrentDate() {
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth() + 1;
    // 获取当前周数（限制在1-4周）
    const firstDay = new Date(year, 0, 1);
    const pastDays = (now - firstDay) / 86400000;
    const week = Math.ceil((pastDays + firstDay.getDay() + 1) / 7);
    // 限制在1-4周
    return { year, month, week: Math.min(Math.max(1, week), 4) };
}

// 初始化时间选择器
function initTimeSelector() {
    const timeTypeBtns = document.querySelectorAll('.time-type-btn');
    const weekInput = document.querySelector('.week-input');
    const yearSelect = document.getElementById('yearSelect');
    const monthSelect = document.getElementById('monthSelect');
    const weekSelect = document.getElementById('weekSelect');
    const timeDisplay = document.getElementById('timeDisplay');
    const categoryInput = document.getElementById('categoryInput');
    const timeTypeInput = document.getElementById('timeTypeInput');

    const currentDate = getCurrentDate();

    // 设置当前时间
    yearSelect.value = currentDate.year;
    monthSelect.value = currentDate.month;
    weekSelect.value = currentDate.week;

    // 更新显示
    updateTimeDisplay();

    // 时间类型切换
    timeTypeBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            timeTypeBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');

            const type = this.dataset.type;
            timeTypeInput.value = type;

            // 显示/隐藏周选择器
            if (type === 'week') {
                weekInput.style.display = 'block';
            } else {
                weekInput.style.display = 'none';
            }

            updateTimeDisplay();
        });
    });

    // 时间选择器变化事件
    yearSelect.addEventListener('change', updateTimeDisplay);
    monthSelect.addEventListener('change', updateTimeDisplay);
    weekSelect.addEventListener('change', updateTimeDisplay);

    // 更新显示的函数
    function updateTimeDisplay() {
        const type = document.querySelector('.time-type-btn.active').dataset.type;
        const year = yearSelect.value;
        const month = monthSelect.value;
        const week = weekSelect.value;

        let displayText = '';
        let categoryValue = '';

        if (type === 'week') {
            displayText = `${year}年第${week}周`;
            categoryValue = `${year}年第${week}周`;
        } else {
            displayText = `${year}年${month}月`;
            categoryValue = `${year}年${month}月`;
        }

        timeDisplay.textContent = displayText;
        categoryInput.value = categoryValue;
    }
}

// 初始化小组选择器
function initGroupSelector() {
    const groupCheckboxes = document.querySelectorAll('.group-checkbox');
    const groupItems = document.querySelectorAll('.group-checkbox-item');
    const selectAllBtn = document.getElementById('selectAllGroups');
    const clearAllBtn = document.getElementById('clearAllGroups');
    const selectedGroupsList = document.getElementById('selectedGroupsList');
    const selectedCount = document.getElementById('selectedCount');

    // 更新选中小组显示
    function updateSelectedGroups() {
        const selectedGroups = [];
        const selectedCheckboxes = document.querySelectorAll('.group-checkbox:checked');

        // 清空显示列表
        selectedGroupsList.innerHTML = '';

        if (selectedCheckboxes.length === 0) {
            selectedGroupsList.innerHTML = '<div class="no-groups-selected">暂未选择小组</div>';
            selectedCount.textContent = '0';
        } else {
            selectedCheckboxes.forEach(checkbox => {
                const groupName = checkbox.value;
                selectedGroups.push(groupName);

                // 创建标签
                const tag = document.createElement('div');
                tag.className = 'selected-group-tag';
                tag.innerHTML = `
                    ${groupName}
                    <i class="fas fa-times" onclick="deselectGroup('${groupName}')"></i>
                `;
                selectedGroupsList.appendChild(tag);
            });

            selectedCount.textContent = selectedCheckboxes.length;
        }

        // 更新每个小组的计数
        updateGroupCounts();
    }

    // 更新小组计数
    function updateGroupCounts() {
        const selectedCheckboxes = document.querySelectorAll('.group-checkbox:checked');
        const count = selectedCheckboxes.length;

        // 更新每个小组项的计数
        document.querySelectorAll('.group-count').forEach(span => {
            span.textContent = count;
        });

        // 更新小组项样式
        groupItems.forEach(item => {
            const checkbox = item.querySelector('.group-checkbox');
            if (checkbox.checked) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
        });
    }

    // 取消选择小组
    window.deselectGroup = function(groupName) {
        const checkbox = document.querySelector(`.group-checkbox[value="${groupName}"]`);
        if (checkbox) {
            checkbox.checked = false;
            checkbox.dispatchEvent(new Event('change'));
        }
    };

    // 全选
    selectAllBtn.addEventListener('click', function() {
        groupCheckboxes.forEach(checkbox => {
            checkbox.checked = true;
        });
        updateSelectedGroups();
    });

    // 清空
    clearAllBtn.addEventListener('click', function() {
        groupCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        updateSelectedGroups();
    });

    // 小组选择事件
    groupCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedGroups);
    });

    // 点击小组项也可以选择
    groupItems.forEach(item => {
        item.addEventListener('click', function(e) {
            if (e.target.type !== 'checkbox' && e.target.tagName !== 'LABEL') {
                const checkbox = this.querySelector('.group-checkbox');
                checkbox.checked = !checkbox.checked;
                checkbox.dispatchEvent(new Event('change'));
            }
        });
    });

    // 初始更新
    updateSelectedGroups();
}

// 表单验证：确保至少选择一个小组
function validateForm() {
    const selectedGroups = document.querySelectorAll('.group-checkbox:checked');
    if (selectedGroups.length === 0) {
        showAlert('请至少选择一个分析小组！', 'warning');
        return false;
    }
    return true;
}

document.addEventListener('DOMContentLoaded', function() {
    initTimeSelector();
    initGroupSelector();
});

document.getElementById('uploadForm').addEventListener('submit', function(e) {
    if (isSubmitting) {
        e.preventDefault();
        return;
    }

    // 验证小组选择
    if (!validateForm()) {
        e.preventDefault();
        return;
    }

    const workloadFiles = document.getElementById('workloadFiles').files;
    const qualityFiles = document.getElementById('qualityFiles').files;
    const costFiles = document.getElementById('costFiles').files;
    const hasAnyFile = workloadFiles.length > 0 || qualityFiles.length > 0 || costFiles.length > 0;

    if (!hasAnyFile) {
        e.preventDefault();
        showAlert('请至少上传一个文件！', 'warning');
        return;
    }

    isSubmitting = true;
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> 正在分析...';

    showAlert('正在上传并分析数据，请稍候...', 'info');
});

// 文件拖拽上传
document.querySelectorAll('.file-upload-card').forEach(area => {
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        area.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        area.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        area.addEventListener(eventName, unhighlight, false);
    });

    function highlight() {
        this.classList.add('dragover');
    }

    function unhighlight() {
        this.classList.remove('dragover');
    }

    area.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        const inputId = this.querySelector('input').id;
        document.getElementById(inputId).files = files;
        updateFileList(inputId, files);
    }
});

function updateFileList(inputId, files) {
    const listId = inputId.replace('Files', 'FileList');
    const listElement = document.getElementById(listId);
    listElement.innerHTML = '';

    Array.from(files).forEach((file, index) => {
        const fileSize = (file.size / 1024 / 1024).toFixed(2);
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item fade-in';
        fileItem.style.animationDelay = `${index * 0.1}s`;
        fileItem.innerHTML = `
            <div class="file-item-info">
                <i class="fas fa-file-excel text-success"></i>
                <div>
                    <div class="file-item-name">${file.name}</div>
                    <div class="file-item-size">${fileSize} MB</div>
                </div>
            </div>
            <button type="button" class="remove-file-btn" onclick="removeFile('${inputId}', '${file.name}')">
                <i class="fas fa-times"></i>
            </button>
        `;
        listElement.appendChild(fileItem);
    });
}

function removeFile(inputId, fileName) {
    const input = document.getElementById(inputId);
    const dt = new DataTransfer();
    const currentFiles = Array.from(input.files);
    const remainingFiles = currentFiles.filter(file => file.name !== fileName);
    remainingFiles.forEach(file => dt.items.add(file));
    input.files = dt.files;
    updateFileList(inputId, input.files);
}

function resetFileLists() {
    document.getElementById('workloadFileList').innerHTML = '';
    document.getElementById('qualityFileList').innerHTML = '';
    document.getElementById('costFileList').innerHTML = '';

    document.getElementById('workloadFiles').value = '';
    document.getElementById('qualityFiles').value = '';
    document.getElementById('costFiles').value = '';

    // 重置小组选择器
    document.querySelectorAll('.group-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    initGroupSelector();

    // 重置时间选择器
    initTimeSelector();

    isSubmitting = false;
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<i class="fas fa-play-circle me-2"></i> 开始智能分析';

    showAlert('表单已重置', 'info');
}

document.getElementById('workloadFiles').addEventListener('change', e => {
    updateFileList('workloadFiles', e.target.files);
});
document.getElementById('qualityFiles').addEventListener('change', e => {
    updateFileList('qualityFiles', e.target.files);
});
document.getElementById('costFiles').addEventListener('change', e => {
    updateFileList('costFiles', e.target.files);
});

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert fade-in position-fixed top-3 end-3`;
    alertDiv.style.cssText = `background: rgba(30,41,59,0.9); border: 1px solid var(--card-border); border-left: 4px solid ${
        type === 'success' ? '#10b981' :
        type === 'error' ? '#ef4444' :
        type === 'warning' ? '#f59e0b' : '#6366f1'
    }; z-index: 9999; min-width: 300px;`;

    alertDiv.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-3"
               style="color: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#6366f1'};"></i>
            <div class="flex-grow-1">${message}</div>
            <button type="button" class="btn-close btn-close-white" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;

    document.body.appendChild(alertDiv);

    setTimeout(() => {
        if (alertDiv.parentElement) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}