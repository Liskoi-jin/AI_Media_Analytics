{% extends "base.html" %}

{% block title %}数据仪表盘 - AI媒介自动化审计分析系统{% endblock %}
{% block page_title %}数据仪表盘{% endblock %}
{% block page_subtitle %}全面洞察媒介数据分析结果{% endblock %}
{% block breadcrumb %}
    <li class="breadcrumb-item active" style="color: var(--text-light);"><i class="fas fa-tachometer-alt me-1"></i>仪表盘</li>
{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2">
    <div class="dropdown">
        <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="fas fa-download me-1"></i> 导出报告
        </button>
        <ul class="dropdown-menu dropdown-advanced">
            <li><a class="dropdown-item" href="{{ url_for('download_report', report_type='workload', analysis_id=analysis_id) if analysis_id else '#' }}">
                <i class="fas fa-briefcase text-blue me-2"></i>工作量报告
            </a></li>
            <li><a class="dropdown-item" href="{{ url_for('download_report', report_type='quality', analysis_id=analysis_id) if analysis_id else '#' }}">
                <i class="fas fa-check-circle text-green me-2"></i>质量分析报告
            </a></li>
            <li><a class="dropdown-item" href="{{ url_for('download_report', report_type='cost', analysis_id=analysis_id) if analysis_id else '#' }}">
                <i class="fas fa-coins text-orange me-2"></i>成本效益报告
            </a></li>
        </ul>
    </div>
    <button class="btn btn-advanced" onclick="refreshDashboard()">
        <i class="fas fa-sync-alt me-1"></i> 刷新数据
    </button>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 16px;
        padding: 25px;
        transition: var(--transition);
        height: 100%;
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, var(--primary), var(--accent));
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-hover);
        border-color: var(--primary);
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        background: rgba(99, 102, 241, 0.1);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
        border: 1px solid rgba(99, 102, 241, 0.2);
        transition: var(--transition);
    }

    .stat-card:hover .stat-icon {
        background: rgba(99, 102, 241, 0.2);
        transform: scale(1.1);
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: 800;
        line-height: 1;
        margin-bottom: 5px;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
    }

    .stat-label {
        color: var(--text-gray);
        font-size: 0.95rem;
        margin-bottom: 10px;
    }

    .stat-trend {
        display: flex;
        align-items: center;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .trend-up {
        color: #10b981;
    }

    .trend-down {
        color: #ef4444;
    }

    .trend-stable {
        color: #6b7280;
    }

    .chart-card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 16px;
        padding: 25px;
        height: 100%;
        transition: var(--transition);
    }

    .chart-card:hover {
        border-color: var(--primary);
        box-shadow: var(--shadow-hover);
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .chart-title {
        font-size: 1.1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .chart-actions {
        display: flex;
        gap: 10px;
    }

    .chart-action-btn {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        background: rgba(30, 41, 59, 0.5);
        border: 1px solid var(--card-border);
        color: var(--text-gray);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
    }

    .chart-action-btn:hover {
        background: rgba(99, 102, 241, 0.2);
        color: var(--primary);
        border-color: var(--primary);
    }

    .table-card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 16px;
        overflow: hidden;
        transition: var(--transition);
    }

    .table-card:hover {
        border-color: var(--primary);
        box-shadow: var(--shadow-hover);
    }

    .table-header {
        background: rgba(99, 102, 241, 0.1);
        padding: 20px;
        border-bottom: 1px solid var(--card-border);
    }

    .table-title {
        font-size: 1.1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 0;
    }

    .group-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .badge-blue {
        background: rgba(22, 93, 255, 0.2);
        color: #165dff;
        border-color: rgba(22, 93, 255, 0.3);
    }

    .badge-green {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
        border-color: rgba(16, 185, 129, 0.3);
    }

    .badge-orange {
        background: rgba(245, 158, 11, 0.2);
        color: #f59e0b;
        border-color: rgba(245, 158, 11, 0.3);
    }

    .badge-purple {
        background: rgba(139, 92, 246, 0.2);
        color: #8b5cf6;
        border-color: rgba(139, 92, 246, 0.3);
    }

    .analysis-info {
        background: rgba(99, 102, 241, 0.1);
        border: 1px solid rgba(99, 102, 241, 0.2);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
    }
</style>
{% endblock %}

{% block content %}
<!-- ========== 数据状态调试信息 ========== -->
{% if upload_success == '1' %}
<div class="alert alert-success alert-dismissible fade show mb-3" role="alert">
    <i class="fas fa-check-circle me-2"></i>
    <strong>分析完成！</strong> 数据已成功加载到仪表盘。
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}

{% if not analysis_data %}
<div class="alert alert-warning mb-3">
    <i class="fas fa-exclamation-triangle me-2"></i>
    <strong>数据加载失败！</strong> 分析数据为空，请重新上传文件进行分析。
</div>
{% endif %}

<!-- 分析信息概览 -->
<div class="analysis-info fade-in">
    <div class="row align-items-center">
        <div class="col-md-8">
            <div class="d-flex align-items-center mb-3">
                <div class="icon-wrapper me-3">
                    <i class="fas fa-chart-pie text-primary"></i>
                </div>
                <div>
                    <h4 class="mb-1">分析概览</h4>
                    <p class="text-muted mb-0">基于上传数据的综合分析结果</p>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-2">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-tags text-primary me-2"></i>
                        <div>
                            <div class="text-sm text-muted">分析类目</div>
                            <div class="fw-medium">{{ analysis_data.get('category', '未知类目') if analysis_data else '未知类目' }}</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-2">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-calendar text-primary me-2"></i>
                        <div>
                            <div class="text-sm text-muted">分析时间</div>
                            <div class="fw-medium">{{ analysis_data.get('timestamp', '未知时间') if analysis_data else '未知时间' }}</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-2">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-users text-primary me-2"></i>
                        <div>
                            <div class="text-sm text-muted">涉及小组</div>
                            <div class="fw-medium">
                                {% if analysis_data and analysis_data.get('selected_groups') %}
                                    {{ analysis_data.selected_groups|join(', ') }}
                                {% else %}
                                    全部小组
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 text-center">
            <div class="position-relative">
                <div class="icon-wrapper mx-auto mb-2" style="width: 80px; height: 80px;">
                    <i class="fas fa-brain fa-2x text-primary"></i>
                </div>
                <div class="text-sm text-muted">AI智能分析完成</div>
                <div class="text-success"><i class="fas fa-check-circle me-1"></i> 数据已就绪</div>
            </div>
        </div>
    </div>
</div>

<!-- 核心指标卡片 -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stat-card fade-in" style="animation-delay: 0.1s;">
            <div class="stat-icon">
                <i class="fas fa-briefcase fa-2x text-blue"></i>
            </div>
            {% if analysis_data and analysis_data.full_result and analysis_data.full_result.workload and analysis_data.full_result.workload.summary %}
                <div class="stat-value">
                    {{ analysis_data.full_result.workload.summary.get('总定档量', 0) }}
                </div>
            {% else %}
                <div class="stat-value">0</div>
            {% endif %}
            <div class="stat-label">总定档量</div>
            <div class="stat-trend">
                <i class="fas fa-arrow-up trend-up me-1"></i>
                <span class="trend-up">较上月 +12.5%</span>
            </div>
            <div class="mt-3">
                <a href="{{ url_for('workload_report', analysis_id=analysis_id) if analysis_id else '#' }}" class="text-primary text-decoration-none d-flex align-items-center">
                    查看详情 <i class="fas fa-arrow-right ms-2"></i>
                </a>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stat-card fade-in" style="animation-delay: 0.2s;">
            <div class="stat-icon">
                <i class="fas fa-check-circle fa-2x text-green"></i>
            </div>
            {% if analysis_data and analysis_data.full_result and analysis_data.full_result.quality and analysis_data.full_result.quality.summary %}
                <div class="stat-value">
                    {{ analysis_data.full_result.quality.summary.get('总体过筛率(%)', 0) }}%
                </div>
            {% else %}
                <div class="stat-value">0%</div>
            {% endif %}
            <div class="stat-label">总体过筛率</div>
            <div class="stat-trend">
                <i class="fas fa-arrow-up trend-up me-1"></i>
                <span class="trend-up">较上月 +5.2%</span>
            </div>
            <div class="mt-3">
                <a href="{{ url_for('quality_report', analysis_id=analysis_id) if analysis_id else '#' }}" class="text-primary text-decoration-none d-flex align-items-center">
                    查看详情 <i class="fas fa-arrow-right ms-2"></i>
                </a>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stat-card fade-in" style="animation-delay: 0.3s;">
            <div class="stat-icon">
                <i class="fas fa-coins fa-2x text-orange"></i>
            </div>
            {% if analysis_data and analysis_data.full_result and analysis_data.full_result.cost and analysis_data.full_result.cost.summary %}
                <div class="stat-value">
    {% if analysis_data and analysis_data.full_result and analysis_data.full_result.cost and analysis_data.full_result.cost.summary %}
        {% set summary = analysis_data.full_result.cost.summary %}
        {{ summary.get('平均CPM', summary.get('平均CPM(元)', 0))|format_number }}
    {% else %}
        0
    {% endif %}
</div>
            {% else %}
                <div class="stat-value">0</div>
            {% endif %}
            <div class="stat-label">平均CPM(元)</div>
            <div class="stat-trend">
                <i class="fas fa-arrow-down trend-down me-1"></i>
                <span class="trend-down">较上月 -8.3%</span>
            </div>
            <div class="mt-3">
                <a href="{{ url_for('cost_report', analysis_id=analysis_id) if analysis_id else '#' }}" class="text-primary text-decoration-none d-flex align-items-center">
                    查看详情 <i class="fas fa-arrow-right ms-2"></i>
                </a>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stat-card fade-in" style="animation-delay: 0.4s;">
            <div class="stat-icon">
                <i class="fas fa-hand-holding-usd fa-2x text-purple"></i>
            </div>
            {% if analysis_data and analysis_data.full_result and analysis_data.full_result.cost and analysis_data.full_result.cost.summary %}
                <div class="stat-value">
                    {{ analysis_data.full_result.cost.summary.get('整体返点占报价比例(%)', '0%') }}
                </div>
            {% else %}
                <div class="stat-value">0%</div>
            {% endif %}
            <div class="stat-label">平均返点比例</div>
            <div class="stat-trend">
                <i class="fas fa-arrow-up trend-up me-1"></i>
                <span class="trend-up">较上月 +2.1%</span>
            </div>
            <div class="mt-3">
                <a href="{{ url_for('cost_report', analysis_id=analysis_id) if analysis_id else '#' }}" class="text-primary text-decoration-none d-flex align-items-center">
                    查看详情 <i class="fas fa-arrow-right ms-2"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- 图表区域 -->
<div class="row mb-4">
    <div class="col-xl-8 mb-4">
        <div class="chart-card fade-in" style="animation-delay: 0.1s;">
            <div class="chart-header">
                <h3 class="chart-title"><i class="fas fa-chart-bar text-blue"></i>各小组工作量对比（定档量）</h3>
                <div class="chart-actions">
                    <button class="chart-action-btn" onclick="downloadChart('workloadGroupChart')" title="下载图表">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="chart-action-btn" onclick="toggleFullscreen(this)" title="全屏">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>
            <div class="chart-container" style="height: 300px;">
                <canvas id="workloadGroupChart"></canvas>
            </div>
        </div>
    </div>

    <div class="col-xl-4 mb-4">
        <div class="chart-card fade-in" style="animation-delay: 0.2s;">
            <div class="chart-header">
                <h3 class="chart-title"><i class="fas fa-chart-pie text-green"></i>工作质量分布</h3>
                <div class="chart-actions">
                    <button class="chart-action-btn" onclick="downloadChart('qualityDistributionChart')" title="下载图表">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
            </div>
            <div class="chart-container" style="height: 300px;">
                <canvas id="qualityDistributionChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- 返点比例分布图表 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="chart-card fade-in" style="animation-delay: 0.3s;">
            <div class="chart-header">
                <h3 class="chart-title"><i class="fas fa-chart-bar text-purple"></i>媒介返点比例分布</h3>
                <div class="chart-actions">
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="fas fa-filter"></i> 筛选
                        </button>
                        <ul class="dropdown-menu dropdown-advanced">
                            <li><a class="dropdown-item" href="javascript:void(0)" onclick="filterRebateChart('all')">全部媒介</a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)" onclick="filterRebateChart('high')">高返点(≥35%)</a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)" onclick="filterRebateChart('medium')">中返点(20-35%)</a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)" onclick="filterRebateChart('low')">低返点(<20%)</a></li>
                        </ul>
                    </div>
                    <button class="chart-action-btn ms-2" onclick="toggleFullscreen(this)" title="全屏">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button class="chart-action-btn ms-2" onclick="downloadChart('rebateDistributionChart')" title="下载图表">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
            </div>
            <div class="chart-container" style="height: 300px;">
                <canvas id="rebateDistributionChart"></canvas>
            </div>
            <div class="mt-3">
                <div class="d-flex flex-wrap gap-3">
                    <div class="d-flex align-items-center">
                        <span class="d-inline-block w-3 h-3 bg-success rounded-circle me-2"></span>
                        <span class="text-sm">高返点(≥35%)</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="d-inline-block w-3 h-3 bg-warning rounded-circle me-2"></span>
                        <span class="text-sm">中返点(20-35%)</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="d-inline-block w-3 h-3 bg-danger rounded-circle me-2"></span>
                        <span class="text-sm">低返点(<20%)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 数据表格区域 -->
<div class="row">
    <!-- 工作量TOP10 -->
    <div class="col-xl-4 col-md-6 mb-4">
        <div class="table-card fade-in" style="animation-delay: 0.1s;">
            <div class="table-header">
                <h4 class="table-title"><i class="fas fa-ranking-star text-blue"></i>工作量TOP10媒介</h4>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th class="border-0">排名</th>
                            <th class="border-0">媒介名称</th>
                            <th class="border-0">所属小组</th>
                            <th class="border-0 text-end">定档量</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set workload_top = [] %}
                        {% if analysis_data and analysis_data.full_result and analysis_data.full_result.workload and analysis_data.full_result.workload.top_media_ranking %}
                            {% set workload_top = analysis_data.full_result.workload.top_media_ranking %}
                        {% elif analysis_data and analysis_data.full_result and analysis_data.full_result.workload and analysis_data.full_result.workload.result %}
                            {% set workload_top = analysis_data.full_result.workload.result %}
                        {% endif %}
                        {% set workload_data = workload_top[:10] if (workload_top is not none and workload_top) else [] %}
                        {% if workload_data|length > 0 %}
                            {% for row in workload_data %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if loop.index <= 3 %}
                                                <i class="fas fa-crown text-warning me-2"></i>
                                            {% endif %}
                                            <span class="fw-bold">{{ row.get('排名', loop.index) }}</span>
                                        </div>
                                    </td>
                                    <td class="fw-medium">{{ row.get('final_media_name', row.get('媒介姓名', '未知媒介')) }}</td>
                                    <td>
                                        {% set group_name = row.get('所属小组', '未知小组') %}
                                        {% if group_name == '数码媒介组' %}
                                            <span class="group-badge badge-blue">{{ group_name }}</span>
                                        {% elif group_name == '快消媒介组' %}
                                            <span class="group-badge badge-green">{{ group_name }}</span>
                                        {% elif group_name == '家居媒介组' %}
                                            <span class="group-badge badge-orange">{{ group_name }}</span>
                                        {% else %}
                                            <span class="group-badge badge-purple">{{ group_name }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end fw-bold">{{ row.get('定档总数', row.get('定档量', 0)) }}</td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="4" class="text-center py-4">
                                    <div class="icon-wrapper mx-auto mb-3" style="width: 60px; height: 60px;">
                                        <i class="fas fa-inbox fa-lg text-muted"></i>
                                    </div>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            <div class="px-3 py-2 border-top" style="border-color: var(--card-border) !important;">
                <a href="{{ url_for('workload_report', analysis_id=analysis_id) if analysis_id else '#' }}" class="text-primary text-decoration-none d-flex align-items-center justify-content-center py-2">
                    查看完整榜单 <i class="fas fa-arrow-right ms-2"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- 工作质量TOP10 -->
<div class="col-xl-4 col-md-6 mb-4">
    <div class="table-card fade-in" style="animation-delay: 0.2s;">
        <div class="table-header">
            <h4 class="table-title"><i class="fas fa-award text-green"></i>工作质量TOP10媒介</h4>
        </div>
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th class="border-0">排名</th>
                        <th class="border-0">媒介名称</th>
                        <th class="border-0">所属小组</th>
                        <th class="border-0 text-end">过筛率</th>
                    </tr>
                </thead>
                <tbody>
                    {% set quality_top = [] %}
                    {% if analysis_data and analysis_data.full_result and analysis_data.full_result.quality %}
                        {% if analysis_data.full_result.quality.result %}
                            {% set all_quality_data = analysis_data.full_result.quality.result %}
                            <!-- ✅ 仪表盘TOP10：手动按过筛率排序 -->
                            {% set sorted_quality = [] %}
                            {% for item in all_quality_data %}
                                {% if item is mapping %}
                                    {% set screening_rate_str = item.get('过筛率(%)', '0%') %}
                                    {% set screening_rate = screening_rate_str|replace('%','')|replace('％','')|float|default(0) %}
                                    {% set _ = item.update({'过筛率数值': screening_rate}) %}
                                    {% set _ = sorted_quality.append(item) %}
                                {% endif %}
                            {% endfor %}
                            <!-- 按过筛率降序排序，取前10 -->
                            {% set quality_top = sorted_quality|sort(attribute='过筛率数值', reverse=true) %}
                        {% endif %}
                    {% endif %}

                    {% set quality_data = quality_top[:10] if (quality_top is not none and quality_top) else [] %}

                    {% if quality_data|length > 0 %}
                        {% for row in quality_data %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        {% if loop.index <= 3 %}
                                            <i class="fas fa-star text-warning me-2"></i>
                                        {% endif %}
                                        <span class="fw-bold">{{ loop.index }}</span>
                                    </div>
                                </td>
                                <td class="fw-medium">{{ row.get('对应名字', row.get('final_media_name', row.get('媒介姓名', '未知媒介'))) }}</td>
                                <td>
                                    {% set group_name = row.get('所属小组', '未知小组') %}
                                    {% if group_name == '数码媒介组' %}
                                        <span class="group-badge badge-blue">{{ group_name }}</span>
                                    {% elif group_name == '快消媒介组' %}
                                        <span class="group-badge badge-green">{{ group_name }}</span>
                                    {% elif group_name == '家居媒介组' %}
                                        <span class="group-badge badge-orange">{{ group_name }}</span>
                                    {% else %}
                                        <span class="group-badge badge-purple">{{ group_name }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-end fw-bold">
                                    {% if '过筛率(%)' in row %}
                                        {{ row['过筛率(%)'] }}
                                    {% elif '过筛率' in row %}
                                        {{ row['过筛率']|float|round(1) }}%
                                    {% else %}
                                        0%
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="4" class="text-center py-4">
                                <div class="icon-wrapper mx-auto mb-3" style="width: 60px; height: 60px;">
                                    <i class="fas fa-chart-line fa-lg text-muted"></i>
                                </div>
                                <div class="text-muted">暂无质量分析数据</div>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        <div class="px-3 py-2 border-top" style="border-color: var(--card-border) !important;">
            <a href="{{ url_for('quality_report', analysis_id=analysis_id) if analysis_id else '#' }}" class="text-primary text-decoration-none d-flex align-items-center justify-content-center py-2">
                查看完整榜单 <i class="fas fa-arrow-right ms-2"></i>
            </a>
        </div>
    </div>
</div>

    <!-- 成本效益TOP10 -->
    <div class="col-xl-4 col-md-6 mb-4">
        <div class="table-card fade-in" style="animation-delay: 0.3s;">
            <div class="table-header">
                <h4 class="table-title"><i class="fas fa-trophy text-orange"></i>成本效益TOP10媒介</h4>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th class="border-0">排名</th>
                            <th class="border-0">媒介名称</th>
                            <th class="border-0">所属小组</th>
                            <th class="border-0 text-end">平均返点比例</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set rebate_top = [] %}
                        {% if analysis_data and analysis_data.full_result and analysis_data.full_result.cost %}
                            {% if analysis_data.full_result.cost.fixed_media_rebate %}
                                {% set all_rebate_data = analysis_data.full_result.cost.fixed_media_rebate %}
                                <!-- 按平均返点比例排序并取前10 -->
                                {% set sorted_rebate = [] %}
                                {% for item in all_rebate_data %}
                                    {% if item is mapping %}
                                        {% set rebate_percent_str = item.get('平均返点比例(%)', '0%') %}
                                        {% set rebate_percent = rebate_percent_str|replace('%','')|float|default(0) %}
                                        {% set _ = item.update({'返点比例数值': rebate_percent}) %}
                                        {% set _ = sorted_rebate.append(item) %}
                                    {% endif %}
                                {% endfor %}
                                <!-- 按返点比例数值降序排序 -->
                                {% set rebate_top = sorted_rebate|sort(attribute='返点比例数值', reverse=true) %}
                            {% endif %}
                        {% endif %}

                        {% set rebate_data = rebate_top[:10] if (rebate_top is not none and rebate_top) else [] %}

                        {% if rebate_data|length > 0 %}
                            {% for row in rebate_data %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if loop.index <= 3 %}
                                                <i class="fas fa-medal text-warning me-2"></i>
                                            {% endif %}
                                            <span class="fw-bold">{{ loop.index }}</span>
                                        </div>
                                    </td>
                                    <td class="fw-medium">{{ row.get('定档媒介', row.get('媒介名称', '未知媒介')) }}</td>
                                    <td>
                                        {% set group_name = row.get('所属小组', row.get('定档媒介小组', '未知小组')) %}
                                        {% if group_name == '数码媒介组' %}
                                            <span class="group-badge badge-blue">{{ group_name }}</span>
                                        {% elif group_name == '快消媒介组' %}
                                            <span class="group-badge badge-green">{{ group_name }}</span>
                                        {% elif group_name == '家居媒介组' %}
                                            <span class="group-badge badge-orange">{{ group_name }}</span>
                                        {% else %}
                                            <span class="group-badge badge-purple">{{ group_name }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end fw-bold">
                                        {% if '平均返点比例(%)' in row %}
                                            {{ row['平均返点比例(%)'] }}
                                        {% elif '平均返点比例' in row %}
                                            {{ row['平均返点比例'] }}%
                                        {% elif '返点比例' in row %}
                                            {{ row['返点比例'] }}%
                                        {% else %}
                                            0%
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="4" class="text-center py-4">
                                    <div class="icon-wrapper mx-auto mb-3" style="width: 60px; height: 60px;">
                                        <i class="fas fa-coins fa-lg text-muted"></i>
                                    </div>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            <div class="px-3 py-2 border-top" style="border-color: var(--card-border) !important;">
                <a href="{{ url_for('cost_report', analysis_id=analysis_id) if analysis_id else '#' }}" class="text-primary text-decoration-none d-flex align-items-center justify-content-center py-2">
                    查看完整榜单 <i class="fas fa-arrow-right ms-2"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- 数据更新状态 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="d-flex align-items-center justify-content-between p-3" style="background: rgba(30, 41, 59, 0.5); border-radius: 12px; border: 1px solid var(--card-border);">
            <div class="d-flex align-items-center">
                <div class="icon-wrapper me-3" style="background: rgba(16, 185, 129, 0.1);">
                    <i class="fas fa-database text-green"></i>
                </div>
                <div>
                    <div class="fw-medium">数据更新时间</div>
                    <div class="text-muted small">{{ analysis_data.get('timestamp', '未知时间') if analysis_data else '未知时间' }}</div>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <div class="me-3 text-end">
                    <div class="fw-medium">数据状态</div>
                    <div class="text-success small"><i class="fas fa-circle me-1"></i> 已就绪</div>
                </div>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt me-1"></i> 手动刷新
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- 使用本地Chart.js -->
<script src="{{ url_for('static', filename='js/chart.umd.min.js') }}"></script>
<script>
// 图表实例和全局数据
let workloadChart, qualityChart;
let rebateChartData = {};

// 等待Chart.js加载
function initializeCharts() {
    if (typeof Chart === 'undefined') {
        console.error('Chart.js未加载');
        setTimeout(initializeCharts, 100);
        return;
    }

    // 1. 各小组工作量对比图表
    let workloadGroups = {};
    {% if analysis_data and analysis_data.full_result and analysis_data.full_result.workload and analysis_data.full_result.workload.summary and analysis_data.full_result.workload.summary.主要小组分布 %}
        workloadGroups = {{ analysis_data.full_result.workload.summary.主要小组分布|tojson|safe }};
    {% endif %}

    const groupNames = Object.keys(workloadGroups);
    const groupValues = groupNames.map(group => {
        const value = workloadGroups[group];
        return Number(value) || 0;
    });

    if (groupNames.length > 0) {
        const workloadCtx = document.getElementById('workloadGroupChart').getContext('2d');
        workloadChart = new Chart(workloadCtx, {
            type: 'bar',
            data: {
                labels: groupNames,
                datasets: [{
                    label: '定档量',
                    data: groupValues,
                    backgroundColor: groupNames.map(group => {
                        if (group === '数码媒介组') return 'rgba(22, 93, 255, 0.7)';
                        if (group === '快消媒介组') return 'rgba(16, 185, 129, 0.7)';
                        if (group === '家居媒介组') return 'rgba(245, 158, 11, 0.7)';
                        return 'rgba(139, 92, 246, 0.7)';
                    }),
                    borderColor: groupNames.map(group => {
                        if (group === '数码媒介组') return 'rgba(22, 93, 255, 1)';
                        if (group === '快消媒介组') return 'rgba(16, 185, 129, 1)';
                        if (group === '家居媒介组') return 'rgba(245, 158, 11, 1)';
                        return 'rgba(139, 92, 246, 1)';
                    }),
                    borderWidth: 1,
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.05)'
                        },
                        ticks: {
                            color: 'rgba(255, 255, 255, 0.6)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: 'rgba(255, 255, 255, 0.6)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(15, 23, 42, 0.9)',
                        borderColor: 'rgba(99, 102, 241, 0.5)',
                        borderWidth: 1,
                        padding: 12,
                        cornerRadius: 8,
                        titleColor: '#fff',
                        bodyColor: '#cbd5e1'
                    }
                }
            }
        });
    }

    // 2. 工作质量分布图表
    let qualityDistribution = {};
    {% if analysis_data and analysis_data.full_result and analysis_data.full_result.quality %}
        {% if analysis_data.full_result.quality.quality_distribution %}
            qualityDistribution = {{ analysis_data.full_result.quality.quality_distribution|tojson|safe }};
        {% elif analysis_data.full_result.quality.summary and analysis_data.full_result.quality.summary.质量分布 %}
            qualityDistribution = {{ analysis_data.full_result.quality.summary.质量分布|tojson|safe }};
        {% endif %}
    {% endif %}

    // 如果是列表格式，转换为对象格式
    if (Array.isArray(qualityDistribution)) {
        const distObj = {};
        qualityDistribution.forEach(item => {
            if (item && item.质量等级) {
                distObj[item.质量等级] = item.媒介数量 || item.数量 || 0;
            }
        });
        qualityDistribution = distObj;
    }

    const qualityLabels = Object.keys(qualityDistribution);
    const qualityValues = Object.values(qualityDistribution).map(v => Number(v) || 0);

    if (qualityLabels.length > 0) {
        const qualityCtx = document.getElementById('qualityDistributionChart').getContext('2d');
        qualityChart = new Chart(qualityCtx, {
            type: 'doughnut',
            data: {
                labels: qualityLabels,
                datasets: [{
                    data: qualityValues,
                    backgroundColor: ['#10B981', '#3B82F6', '#F59E0B', '#F97316', '#EF4444', '#8B5CF6'].slice(0, qualityLabels.length),
                    borderWidth: 0,
                    hoverOffset: 15
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: 'rgba(255, 255, 255, 0.7)',
                            padding: 20,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    } else {
        const qualityCtx = document.getElementById('qualityDistributionChart').getContext('2d');
        qualityChart = new Chart(qualityCtx, {
            type: 'doughnut',
            data: {
                labels: ['暂无数据'],
                datasets: [{
                    data: [1],
                    backgroundColor: ['#6B7280'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        enabled: false
                    }
                }
            }
        });
    }

    // 3. 返点比例分布图表初始化
    initializeRebateDistributionChart();
}

// 返点比例分布图表初始化函数
function initializeRebateDistributionChart() {
    const rebateCtx = document.getElementById('rebateDistributionChart');
    if (!rebateCtx) return;

    // 从分析数据中获取返点数据
    let rebateData = [];
    {% if analysis_data and analysis_data.full_result and analysis_data.full_result.cost %}
        {% if analysis_data.full_result.cost.fixed_media_rebate %}
            rebateData = {{ analysis_data.full_result.cost.fixed_media_rebate|tojson|safe }};
        {% elif analysis_data.full_result.cost.result %}
            rebateData = {{ analysis_data.full_result.cost.result|tojson|safe }};
        {% endif %}
    {% endif %}

    let allMediaNames = [];
    let rebateValues = [];

    if (rebateData && rebateData.length > 0) {
        allMediaNames = rebateData.map(item => {
            return item['定档媒介'] ||
                   item['媒介名称'] ||
                   item['final_media_name'] ||
                   item['媒介姓名'] ||
                   '未知媒介';
        }).filter(name => name && name !== '未知媒介');

        rebateValues = rebateData.map(item => {
            let rebatePercent = 0;
            const possibleKeys = ['平均返点比例(%)', '返点比例(%)', '平均返点比例', '返点比例', '返点(%)', '返点'];

            for (const key of possibleKeys) {
                if (item[key] && item[key] !== 'N/A') {
                    const valueStr = String(item[key]);
                    const value = parseFloat(valueStr.replace('%', '').replace('％', ''));
                    if (!isNaN(value)) {
                        rebatePercent = value;
                        break;
                    }
                }
            }

            return rebatePercent;
        }).filter(val => val !== 0 && !isNaN(val));

        // 如果数据过多，只显示前20个
        if (allMediaNames.length > 20) {
            allMediaNames = allMediaNames.slice(0, 20);
            rebateValues = rebateValues.slice(0, 20);
        }
    }

    // 如果没有数据，显示示例数据
    if (allMediaNames.length === 0 || rebateValues.length === 0) {
        allMediaNames = ['媒介A', '媒介B', '媒介C', '媒介D', '媒介E', '媒介F'];
        rebateValues = [45.5, 32.1, 28.7, 18.9, 52.3, 24.6];
    }

    // 根据返点值设置颜色
    const backgroundColors = rebateValues.map(value => {
        if (value >= 35) return 'rgba(16, 185, 129, 0.7)';
        if (value >= 20) return 'rgba(245, 158, 11, 0.7)';
        return 'rgba(239, 68, 68, 0.7)';
    });

    const borderColors = rebateValues.map(value => {
        if (value >= 35) return 'rgba(16, 185, 129, 1)';
        if (value >= 20) return 'rgba(245, 158, 11, 1)';
        return 'rgba(239, 68, 68, 1)';
    });

    // 存储原始数据用于筛选
    rebateChartData = {
        allMediaNames: [...allMediaNames],
        allRebateValues: [...rebateValues],
        allBackgroundColors: [...backgroundColors],
        allBorderColors: [...borderColors]
    };

    // 销毁现有图表
    if (window.rebateChart) {
        window.rebateChart.destroy();
    }

    // 创建新图表
    window.rebateChart = new Chart(rebateCtx.getContext('2d'), {
        type: 'bar',
        data: {
            labels: allMediaNames,
            datasets: [{
                label: '返点比例(%)',
                data: rebateValues,
                backgroundColor: backgroundColors,
                borderColor: borderColors,
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '返点比例(%)',
                        color: 'rgba(255, 255, 255, 0.7)'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.05)'
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.6)',
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: '媒介名称',
                        color: 'rgba(255, 255, 255, 0.7)'
                    },
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.6)',
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `返点比例: ${context.raw.toFixed(2)}%`;
                        }
                    },
                    backgroundColor: 'rgba(15, 23, 42, 0.9)',
                    borderColor: 'rgba(139, 92, 246, 0.5)',
                    borderWidth: 1,
                    padding: 12,
                    cornerRadius: 8,
                    titleColor: '#fff',
                    bodyColor: '#cbd5e1'
                }
            }
        }
    });
}

// 返点图表筛选函数
function filterRebateChart(filterType) {
    if (!window.rebateChart || !rebateChartData.allMediaNames) {
        alert('图表数据未加载，请刷新页面重试');
        return;
    }

    let filteredData = [];
    let filteredLabels = [];
    let filteredColors = [];
    let filteredBorderColors = [];

    // 遍历所有数据
    for (let i = 0; i < rebateChartData.allMediaNames.length; i++) {
        const value = rebateChartData.allRebateValues[i];
        const label = rebateChartData.allMediaNames[i];
        const bgColor = rebateChartData.allBackgroundColors[i];
        const borderColor = rebateChartData.allBorderColors[i];

        let shouldInclude = false;

        switch(filterType) {
            case 'all':
                shouldInclude = true;
                break;
            case 'high':
                shouldInclude = value >= 35;
                break;
            case 'medium':
                shouldInclude = value >= 20 && value < 35;
                break;
            case 'low':
                shouldInclude = value < 20;
                break;
            default:
                shouldInclude = true;
        }

        if (shouldInclude) {
            filteredData.push(value);
            filteredLabels.push(label);
            filteredColors.push(bgColor);
            filteredBorderColors.push(borderColor);
        }
    }

    // 如果没有数据，显示提示
    if (filteredData.length === 0) {
        filteredData = [0];
        filteredLabels = ['无符合条件的数据'];
        filteredColors = ['rgba(128, 128, 128, 0.7)'];
        filteredBorderColors = ['rgba(128, 128, 128, 1)'];
    }

    // 更新图表数据
    window.rebateChart.data.datasets[0].data = filteredData;
    window.rebateChart.data.datasets[0].backgroundColor = filteredColors;
    window.rebateChart.data.datasets[0].borderColor = filteredBorderColors;
    window.rebateChart.data.labels = filteredLabels;

    // 更新图表
    window.rebateChart.update();

    // 显示筛选结果信息
    const chartTitle = document.querySelector('#rebateDistributionChart').closest('.chart-card').querySelector('.chart-title');
    let filterText = '';
    let countText = '';

    switch(filterType) {
        case 'all':
            filterText = '全部媒介';
            countText = filteredData.length > 1 ? `, 共${filteredData.length}个媒介` : '';
            break;
        case 'high':
            filterText = '高返点(≥35%)';
            countText = filteredData.length > 1 ? `, 共${filteredData.length}个媒介` : '';
            break;
        case 'medium':
            filterText = '中返点(20-35%)';
            countText = filteredData.length > 1 ? `, 共${filteredData.length}个媒介` : '';
            break;
        case 'low':
            filterText = '低返点(<20%)';
            countText = filteredData.length > 1 ? `, 共${filteredData.length}个媒介` : '';
            break;
    }

    chartTitle.innerHTML = `<i class="fas fa-chart-bar text-purple"></i>媒介返点比例分布 (${filterText}${countText})`;
}

// 初始化
document.addEventListener('DOMContentLoaded', initializeCharts);

// 图表功能函数
function downloadChart(chartId) {
    const canvas = document.getElementById(chartId);
    if (!canvas) {
        alert('图表不存在，无法下载');
        return;
    }
    const link = document.createElement('a');
    link.download = `${chartId}-${new Date().toISOString().split('T')[0]}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
}

function toggleFullscreen(button) {
    const chartCard = button.closest('.chart-card');
    chartCard.classList.toggle('fullscreen');
    const icon = button.querySelector('i');
    if (chartCard.classList.contains('fullscreen')) {
        chartCard.style.position = 'fixed';
        chartCard.style.top = '0';
        chartCard.style.left = '0';
        chartCard.style.width = '100vw';
        chartCard.style.height = '100vh';
        chartCard.style.zIndex = '9999';
        chartCard.style.borderRadius = '0';
        icon.classList.replace('fa-expand', 'fa-compress');
    } else {
        chartCard.style.position = '';
        chartCard.style.top = '';
        chartCard.style.left = '';
        chartCard.style.width = '';
        chartCard.style.height = '';
        chartCard.style.zIndex = '';
        chartCard.style.borderRadius = '';
        icon.classList.replace('fa-compress', 'fa-expand');
    }
}

function refreshDashboard() {
    const refreshBtn = event?.target?.closest('button') || document.querySelector('button[onclick="refreshDashboard()"]');
    if (refreshBtn) {
        const originalText = refreshBtn.innerHTML;
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> 刷新中...';
        refreshBtn.disabled = true;

        setTimeout(() => {
            location.reload();
        }, 1000);
    }
}

// 监听ESC键退出全屏
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        document.querySelectorAll('.chart-card.fullscreen').forEach(card => {
            card.classList.remove('fullscreen');
            card.style.position = '';
            card.style.top = '';
            card.style.left = '';
            card.style.width = '';
            card.style.height = '';
            card.style.zIndex = '';
            card.style.borderRadius = '';
            const icon = card.querySelector('.chart-action-btn i.fa-compress');
            if (icon) {
                icon.classList.replace('fa-compress', 'fa-expand');
            }
        });
    }
});
</script>
{% endblock %}