{% extends "base.html" %}

{% block title %}工作量分析 - AI媒介自动化审计分析系统{% endblock %}
{% block page_title %}工作量分析{% endblock %}
{% block page_subtitle %}深入分析媒介定档量与工作量情况{% endblock %}
{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="{{ url_for('dashboard', analysis_id=analysis_id) }}" class="text-decoration-none text-primary fw-medium" style="font-size: 16px;"><i class="fas fa-tachometer-alt me-1"></i>仪表盘</a></li>
    <li class="breadcrumb-item active" style="color: var(--text-light);"><i class="fas fa-briefcase me-1"></i>工作量分析</li>
{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2">
    <!-- 替换现有的导出下拉菜单 -->
<div class="dropdown">
    <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
        <i class="fas fa-download me-1"></i> 导出
    </button>
    <ul class="dropdown-menu dropdown-advanced">
        <li><a class="dropdown-item" href="{{ url_for('download_report', report_type='workload', analysis_id=analysis_id) }}">
            <i class="fas fa-file-excel text-success me-2"></i>导出完整Excel报告
        </a></li>
        <li><a class="dropdown-item" href="{{ url_for('download_table', table_type='workload_detail', analysis_id=analysis_id) }}">
            <i class="fas fa-table text-info me-2"></i>导出工作量明细
        </a></li>
        <li><a class="dropdown-item" href="{{ url_for('download_table', table_type='workload_group', analysis_id=analysis_id) }}">
            <i class="fas fa-users text-warning me-2"></i>导出小组汇总
        </a></li>
        <li><a class="dropdown-item" href="{{ url_for('download_table', table_type='workload_top', analysis_id=analysis_id) }}">
            <i class="fas fa-trophy text-primary me-2"></i>导出TOP排名
        </a></li>
        <!-- 删除导出图表选项 -->
    </ul>
</div>
    <button class="btn btn-advanced" onclick="toggleWorkloadView()">
        <i class="fas fa-exchange-alt me-1"></i> 切换视图
    </button>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .workload-section {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 16px;
        padding: 25px;
        margin-bottom: 25px;
        transition: var(--transition);
    }

    .workload-section:hover {
        border-color: var(--primary);
        box-shadow: var(--shadow-hover);
    }

    .section-header {
        display: flex;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 20px;
        border-bottom: 2px solid var(--card-border);
    }

    .section-icon {
        width: 50px;
        height: 50px;
        background: rgba(22, 93, 255, 0.15);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        border: 1px solid rgba(22, 93, 255, 0.25);
    }

    .section-icon i {
        color: #165dff;
        font-size: 1.3rem;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-light);
        margin: 0;
    }

    .section-subtitle {
        color: var(--text-gray);
        font-size: 0.95rem;
        margin-top: 5px;
    }

    .workload-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
    }

    .workload-card {
        background: rgba(30, 41, 59, 0.5);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid var(--card-border);
        transition: var(--transition);
    }

    .workload-card:hover {
        border-color: #165dff;
        transform: translateY(-3px);
    }

    .workload-value {
        font-size: 2.2rem;
        font-weight: 700;
        background: linear-gradient(90deg, #165dff, #1d4ed8);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        line-height: 1;
        margin-bottom: 5px;
    }

    .workload-label {
        color: var(--text-gray);
        font-size: 0.9rem;
        margin-bottom: 10px;
    }

    .workload-trend {
        display: flex;
        align-items: center;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .workload-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }

    .badge-s-level {
        background: rgba(139, 92, 246, 0.2);
        color: #8b5cf6;
        border: 1px solid rgba(139, 92, 246, 0.3);
    }

    .badge-a-level {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
        border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .badge-b-level {
        background: rgba(59, 130, 246, 0.2);
        color: #3b82f6;
        border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .badge-c-level {
        background: rgba(245, 158, 11, 0.2);
        color: #f59e0b;
        border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .badge-d-level {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .comparison-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
    }

    .comparison-item {
        background: rgba(30, 41, 59, 0.5);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid var(--card-border);
    }

    .comparison-label {
        color: var(--text-gray);
        font-size: 0.9rem;
        margin-bottom: 8px;
    }

    .comparison-bar {
        height: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 8px;
    }

    .comparison-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s ease;
    }

    .no-data {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-gray);
    }

    .no-data-icon {
        width: 80px;
        height: 80px;
        background: rgba(22, 93, 255, 0.1);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        border: 2px solid rgba(22, 93, 255, 0.2);
    }

    .no-data-icon i {
        color: #165dff;
        font-size: 2rem;
    }

    .table-tabs {
        border-bottom: 2px solid var(--card-border);
        margin-bottom: 20px;
    }

    .table-tab {
        padding: 12px 25px;
        background: transparent;
        border: none;
        color: var(--text-gray);
        font-weight: 500;
        position: relative;
        transition: var(--transition);
        cursor: pointer;
        font-size: 0.95rem;
    }

    .table-tab:hover {
        color: var(--primary);
    }

    .table-tab.active {
        color: #165dff;
    }

    .table-tab.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 100%;
        height: 2px;
        background: #165dff;
    }

    .status-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .status-returned {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
        border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .status-scheduled {
        background: rgba(59, 130, 246, 0.2);
        color: #3b82f6;
        border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .status-other {
        background: rgba(107, 114, 128, 0.2);
        color: #6b7280;
        border: 1px solid rgba(107, 114, 128, 0.3);
    }

    .search-container {
        margin-bottom: 20px;
    }

    /* 表格样式修改为深色背景 */
    .table-advanced {
        background: var(--card-bg);
        color: var(--text-light);
        border-color: var(--card-border);
    }

    .table-advanced thead th {
        background: rgba(15, 23, 42, 0.7);
        border-bottom: 2px solid var(--card-border);
        color: var(--text-light);
        font-weight: 600;
        padding: 12px 16px;
    }

    .table-advanced tbody td {
        background: rgba(30, 41, 59, 0.5);
        border-color: var(--card-border);
        padding: 12px 16px;
        color: var(--text-light);
    }

    .table-advanced tbody tr:hover td {
        background: rgba(22, 93, 255, 0.1);
    }

    .table-advanced tbody tr:nth-child(even) td {
        background: rgba(30, 41, 59, 0.3);
    }

    .table-advanced tbody tr:hover:nth-child(even) td {
        background: rgba(22, 93, 255, 0.15);
    }

    /* 小组徽章样式 */
    .group-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
        white-space: nowrap;
    }

    .badge-blue {
        background: rgba(59, 130, 246, 0.2);
        color: #3b82f6;
        border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .badge-green {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
        border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .badge-orange {
        background: rgba(245, 158, 11, 0.2);
        color: #f59e0b;
        border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .badge-gray {
        background: rgba(107, 114, 128, 0.2);
        color: #6b7280;
        border: 1px solid rgba(107, 114, 128, 0.3);
    }
</style>
{% endblock %}

{% block content %}
{% macro safe_divide(numerator, denominator) %}
    {% if denominator and denominator != 0 %}
        {{ numerator / denominator }}
    {% else %}
        0
    {% endif %}
{% endmacro %}

<!-- 概览区域 -->
<div class="workload-section fade-in">
    <div class="section-header">
        <div class="section-icon">
            <i class="fas fa-chart-bar"></i>
        </div>
        <div>
            <h2 class="section-title">工作量概览</h2>
            <div class="section-subtitle">分析模式: {{ analysis_mode }} | 分析时间: {{ analysis_data.timestamp|default("未知") }}</div>
        </div>
    </div>

    <!-- 核心指标卡片 -->
    <div class="workload-cards">
        <div class="workload-card">
            <div class="workload-value">
                {{ workload_summary.get('总定档量', 0) }}
            </div>
            <div class="workload-label">总定档量</div>
            <div class="workload-trend">
                <i class="fas fa-bullseye me-1"></i>
                <span>已发布: {{ workload_summary.get('总已发布数', 0)|default(0) }}</span>
            </div>
        </div>

        <div class="workload-card">
            <div class="workload-value">
                {{ workload_summary.get('整体定档率', '0.00%') }}
            </div>
            <div class="workload-label">整体定档率</div>
            <div class="workload-trend">
                <i class="fas fa-chart-line me-1"></i>
                <span>总处理量: {{ workload_summary.get('总处理量', 0)|default(0) }}</span>
            </div>
        </div>

        <div class="workload-card">
            <div class="workload-value">
                {{ workload_summary.get('S级媒介数', 0)|default(0) }}
            </div>
            <div class="workload-label">S级媒介数</div>
            <div class="workload-trend">
                <i class="fas fa-crown me-1 text-warning"></i>
                <span>A级及以上: {{ workload_summary.get('A级及以上媒介数', 0)|default(0) }}</span>
            </div>
        </div>

        <div class="workload-card">
            <div class="workload-value">
                {{ workload_summary.get('媒介总数', 0)|default(0) }}
            </div>
            <div class="workload-label">总媒介数</div>
            <div class="workload-trend">
                <i class="fas fa-users me-1"></i>
                <span>小组数: {{ group_summary|length|default(0) }}</span>
            </div>
        </div>
    </div>
</div>

<!-- 图表区域 - 修改：删除整个图表部分 -->
<div class="workload-section fade-in" style="animation-delay: 0.1s;">
    <div class="section-header">
        <div class="section-icon">
            <i class="fas fa-chart-line"></i>
        </div>
        <div>
            <h2 class="section-title">工作量分布分析</h2>
            <div class="section-subtitle">各小组工作量对比与趋势分析</div>
        </div>
    </div>

    <!-- 删除：这里原本是图表容器 -->

    <!-- 只保留小组对比 -->
    <div class="comparison-grid">
        <div class="comparison-item">
            <div class="comparison-label">各小组定档总量</div>
            {% if group_summary and group_summary|length > 0 %}
                {% for group in group_summary %}
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span style="color: var(--text-light);">{{ group.所属小组|default('未知') }}</span>
                            <span class="comparison-value text-primary">
                                {{ group.总定档量|default(0) }} 条
                            </span>
                        </div>
                        <div class="comparison-bar">
                            {% set total_value = group.总定档量|default(0) %}
                            {% set max_value = group_summary|map(attribute='总定档量')|default([])|map('default', 0)|max or 1 %}
                            <div class="comparison-fill"
                                 style="background: linear-gradient(90deg, #165dff, #1d4ed8);
                                        width: {{ (total_value/max_value*100)|int }}%;"></div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="no-data" style="padding: 20px 0;">
                    <div class="no-data-icon" style="width: 50px; height: 50px;">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <div style="color: var(--text-gray);">暂无小组数据</div>
                </div>
            {% endif %}
        </div>

        <div class="comparison-item">
            <div class="comparison-label">各小组平均定档率</div>
            {% if group_summary and group_summary|length > 0 %}
                {% for group in group_summary %}
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span style="color: var(--text-light);">{{ group.所属小组|default('未知') }}</span>
                            {% set rate_str = group.get('小组定档率(%)', '0.00%')|default('0.00%') %}
                            {% set rate_value = rate_str|replace('%', '')|replace(' ', '')|float|default(0) %}
                            <span class="comparison-value {% if rate_value > 80 %}text-success{% elif rate_value > 60 %}text-warning{% else %}text-danger{% endif %}">
                                {{ "%.1f"|format(rate_value) }}%
                            </span>
                        </div>
                        <div class="comparison-bar">
                            <div class="comparison-fill"
                                 style="background: linear-gradient(90deg,
                                        {% if rate_value > 80 %}#10b981
                                        {% elif rate_value > 60 %}#f59e0b
                                        {% else %}#ef4444{% endif %},
                                        {% if rate_value > 80 %}#059669
                                        {% elif rate_value > 60 %}#d97706
                                        {% else %}#dc2626{% endif %});
                                        width: {{ [rate_value, 100]|min|int }}%;"></div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="no-data" style="padding: 20px 0;">
                    <div class="no-data-icon" style="width: 50px; height: 50px;">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <div style="color: var(--text-gray);">暂无小组数据</div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 数据表格区域 -->
<div class="workload-section fade-in" style="animation-delay: 0.2s;">
    <div class="section-header">
        <div class="section-icon">
            <i class="fas fa-table"></i>
        </div>
        <div>
            <h2 class="section-title">详细数据</h2>
            <div class="section-subtitle">工作量明细数据与筛选查看</div>
        </div>
    </div>

    <!-- 搜索框 -->
    <div class="search-container">
        <div class="input-group">
            <span class="input-group-text bg-dark border-secondary">
                <i class="fas fa-search"></i>
            </span>
            <input type="text" id="searchWorkloadInput" class="form-control form-control-advanced"
                   placeholder="搜索媒介姓名、对应真名或所属小组..." onkeyup="searchWorkloadData()">
        </div>
    </div>

    <!-- 表格标签页 -->
    <div class="table-tabs">
        <button class="table-tab active" onclick="showTable('workloadDetail')">工作量明细</button>
        <button class="table-tab" onclick="showTable('workloadTop')">工作量TOP排名</button>
        <button class="table-tab" onclick="showTable('groupSummary')">小组汇总</button>
    </div>

    <!-- 工作量明细表格 -->
    <div id="workloadDetailTable" class="table-content">
        <div class="table-responsive">
            <table class="table table-advanced table-hover">
                <thead>
                    <tr>
                        <th>排名</th>
                        <th>媒介姓名</th>
                        <th>对应真名</th>
                        <th>所属小组</th>
                        <th>总处理量</th>
                        <th>定档量</th>
                        <th>已发布</th>
                        <th>未发布</th>
                        <th>其他状态</th>
                        <th>定档率(%)</th>
                        <th>定档率评估</th>
                        <th>产量评估</th>
                        <th>综合评估</th>
                    </tr>
                </thead>
                <tbody>
                    {% if detail_data and detail_data|length > 0 %}
                        {% for row in detail_data %}
                        <tr data-search="{{ row.媒介姓名|default('')|lower }} {{ row.对应真名|default('')|lower }} {{ row.所属小组|default('')|lower }}">
                            <td class="fw-bold">{{ loop.index }}</td>
                            <td class="fw-medium">{{ row.媒介姓名|default('未知') }}</td>
                            <td>{{ row.对应真名|default('未知') }}</td>
                            <td>
                                <span class="group-badge {% if row.所属小组|default('') == '家居媒介组' %}badge-blue{% elif row.所属小组|default('') == '快消媒介组' %}badge-green{% elif row.所属小组|default('') == '数码媒介组' %}badge-orange{% else %}badge-gray{% endif %}">
                                    {{ row.所属小组|default('未知') }}
                                </span>
                            </td>
                            <td>{{ row.总处理量|default(0) }}</td>
                            <td class="text-primary fw-bold">{{ row.定档量|default(0) }}</td>
                            <td>
                                <span class="status-badge status-returned">{{ row.已发布数|default(0) }}</span>
                            </td>
                            <td>
                                <span class="status-badge status-scheduled">{{ row.未发布数|default(0) }}</span>
                            </td>
                            <td>
                                <span class="status-badge status-other">{{ row.其他状态数|default(0) }}</span>
                            </td>
                            <td>
                                {% set rate_str = row.get('定档率(%)', '0.00%')|default('0.00%') %}
                                {% set rate_value = rate_str|replace('%', '')|replace(' ', '')|float|default(0) %}
                                <span class="{% if rate_value > 80 %}text-success{% elif rate_value > 60 %}text-warning{% else %}text-danger{% endif %} fw-bold">
                                    {{ rate_str }}
                                </span>
                            </td>
                            <td>
                                {% set rate_eval = row.定档率评估|default('未知') %}
                                <span class="badge {% if rate_eval == '优秀' %}bg-success{% elif rate_eval == '良好' %}bg-info{% elif rate_eval == '一般' %}bg-warning{% elif rate_eval == '待改进' %}bg-danger{% else %}bg-secondary{% endif %}">
                                    {{ rate_eval }}
                                </span>
                            </td>
                            <td>
                                {% set output_eval = row.产量评估|default('未知') %}
                                <span class="badge {% if output_eval == '高产' %}bg-success{% elif output_eval == '中产' %}bg-info{% elif output_eval == '低产' %}bg-warning{% else %}bg-secondary{% endif %}">
                                    {{ output_eval }}
                                </span>
                            </td>
                            <td>
                                {% set rating = row.综合评估|default('未知') %}
                                <span class="workload-badge
                                    {% if rating == 'S级' %}badge-s-level
                                    {% elif rating == 'A级' %}badge-a-level
                                    {% elif rating == 'B级' %}badge-b-level
                                    {% elif rating == 'C级' %}badge-c-level
                                    {% else %}badge-d-level{% endif %}">
                                    <i class="fas fa-{% if rating == 'S级' %}crown{% elif rating == 'A级' %}star{% elif rating == 'B级' %}medal{% elif rating == 'C级' %}chart-line{% else %}exclamation-circle{% endif %}"></i>
                                    {{ rating }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="13" class="text-center py-5">
                                <div class="no-data">
                                    <div class="no-data-icon">
                                        <i class="fas fa-briefcase"></i>
                                    </div>
                                    <h5 style="color: var(--text-light); margin: 15px 0 10px;">暂无工作量明细数据</h5>
                                    <p style="color: var(--text-gray);">请上传定档数据进行工作量分析</p>
                                </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- 工作量TOP排名表格 -->
    <div id="workloadTopTable" class="table-content" style="display: none;">
        <div class="table-responsive">
            <table class="table table-advanced table-hover">
                <thead>
                    <tr>
                        <th>排名</th>
                        <th>媒介姓名</th>
                        <th>对应真名</th>
                        <th>所属小组</th>
                        <th>总处理量</th>
                        <th>定档量</th>
                        <th>定档率(%)</th>
                        <th>综合评估</th>
                    </tr>
                </thead>
                <tbody>
                    {% if top_ranking and top_ranking|length > 0 %}
                        {% for row in top_ranking %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    {% if loop.index <= 3 %}
                                        <i class="fas fa-crown text-warning me-2"></i>
                                    {% endif %}
                                    <span class="fw-bold">{{ row.排名|default(loop.index) }}</span>
                                </div>
                            </td>
                            <td class="fw-medium">{{ row.媒介姓名|default('未知') }}</td>
                            <td>{{ row.对应真名|default('未知') }}</td>
                            <td>
                                <span class="group-badge {% if row.所属小组|default('') == '家居媒介组' %}badge-blue{% elif row.所属小组|default('') == '快消媒介组' %}badge-green{% elif row.所属小组|default('') == '数码媒介组' %}badge-orange{% else %}badge-gray{% endif %}">
                                    {{ row.所属小组|default('未知') }}
                                </span>
                            </td>
                            <td>{{ row.总处理量|default(0) }}</td>
                            <td class="text-primary fw-bold">{{ row.定档量|default(0) }}</td>
                            <td>
                                {% set rate_str = row.get('定档率(%)', '0.00%')|default('0.00%') %}
                                {% set rate_value = rate_str|replace('%', '')|replace(' ', '')|float|default(0) %}
                                <span class="{% if rate_value > 80 %}text-success{% elif rate_value > 60 %}text-warning{% else %}text-danger{% endif %} fw-bold">
                                    {{ rate_str }}
                                </span>
                            </td>
                            <td>
                                {% set rating = row.综合评估|default('未知') %}
                                <span class="workload-badge
                                    {% if rating == 'S级' %}badge-s-level
                                    {% elif rating == 'A级' %}badge-a-level
                                    {% elif rating == 'B级' %}badge-b-level
                                    {% elif rating == 'C级' %}badge-c-level
                                    {% else %}badge-d-level{% endif %}">
                                    {{ rating }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="8" class="text-center py-5">
                                <div class="no-data">
                                    <div class="no-data-icon">
                                        <i class="fas fa-trophy"></i>
                                    </div>
                                    <h5 style="color: var(--text-light); margin: 15px 0 10px;">暂无TOP排名数据</h5>
                                    <p style="color: var(--text-gray);">请上传完整数据进行排名分析</p>
                                </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- 小组汇总表格 -->
    <div id="groupSummaryTable" class="table-content" style="display: none;">
        <div class="table-responsive">
            <table class="table table-advanced table-hover">
                <thead>
                    <tr>
                        <th>小组名称</th>
                        <th>媒介数量</th>
                        <th>总处理量</th>
                        <th>总定档量</th>
                        <th>总已发布</th>
                        <th>总未发布</th>
                        <th>小组定档率(%)</th>
                        <th>小组发布率(%)</th>
                        <th>处理量占比(%)</th>
                    </tr>
                </thead>
                <tbody>
                    {% if group_summary and group_summary|length > 0 %}
                        {% for row in group_summary %}
                        <tr>
                            <td class="fw-medium">{{ row.所属小组|default('未知') }}</td>
                            <td>{{ row.媒介数量|default(0) }}</td>
                            <td>{{ row.总处理量|default(0) }}</td>
                            <td>{{ row.总定档量|default(0) }}</td>
                            <td>
                                <span class="status-badge status-returned">{{ row.总已发布数|default(0) }}</span>
                            </td>
                            <td>
                                <span class="status-badge status-scheduled">{{ row.总未发布数|default(0) }}</span>
                            </td>
                            <td>
                                {% set rate_str = row.get('小组定档率(%)', '0.00%')|default('0.00%') %}
                                {% set rate_value = rate_str|replace('%', '')|replace(' ', '')|float|default(0) %}
                                <span class="{% if rate_value > 80 %}text-success{% elif rate_value > 60 %}text-warning{% else %}text-danger{% endif %} fw-bold">
                                    {{ rate_str }}
                                </span>
                            </td>
                            <td>
                                {% set release_str = row.get('小组发布率(%)', '0.00%')|default('0.00%') %}
                                {% set release_value = release_str|replace('%', '')|replace(' ', '')|float|default(0) %}
                                <span class="{% if release_value > 80 %}text-success{% elif release_value > 60 %}text-warning{% else %}text-danger{% endif %}">
                                    {{ release_str }}
                                </span>
                            </td>
                            <td>
                                {% set ratio_str = row.get('处理量占比(%)', '0.00%')|default('0.00%') %}
                                <span class="text-info">{{ ratio_str }}</span>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="9" class="text-center py-5">
                                <div class="no-data">
                                    <div class="no-data-icon">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <h5 style="color: var(--text-light); margin: 15px 0 10px;">暂无小组汇总数据</h5>
                                    <p style="color: var(--text-gray);">请上传完整数据进行小组分析</p>
                                </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.staticfile.org/chart.js/4.4.8/chart.umd.min.js"></script>
<script>
let currentTable = 'workloadDetail';

// 初始化图表 - 修改：删除图表初始化代码
document.addEventListener('DOMContentLoaded', function() {
    // 图表已删除，不再初始化
});

// 删除：initWorkloadChart 函数
// 删除：exportChart 函数中的图表导出部分

function showTable(tableId) {
    // 更新标签页状态
    document.querySelectorAll('.table-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');

    // 隐藏所有表格
    document.querySelectorAll('.table-content').forEach(content => {
        content.style.display = 'none';
    });

    // 显示选中的表格
    document.getElementById(tableId + 'Table').style.display = 'block';
    currentTable = tableId;
}

function exportChart(chartId) {
    // 图表已删除，此函数可能不需要
    alert("图表功能已禁用，请使用导出Excel报告功能");
}

function searchWorkloadData() {
    const searchTerm = document.getElementById('searchWorkloadInput').value.toLowerCase().trim();
    const tableRows = document.querySelectorAll(`#${currentTable}Table tbody tr`);

    if (searchTerm === '') {
        tableRows.forEach(row => {
            row.style.display = '';
        });
        return;
    }

    tableRows.forEach(row => {
        const searchData = row.getAttribute('data-search') || '';
        if (searchData.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function toggleWorkloadView() {
    const currentView = document.querySelector('.table-content[style*="display: block"]');
    if (currentView) {
        // 如果是表格视图，因为没有图表，所以不切换
        alert("图表视图已禁用");
    } else {
        // 显示表格视图
        document.getElementById('workloadDetailTable').style.display = 'block';
        document.querySelector('.search-container').style.display = 'block';
        document.querySelector('.table-tabs').style.display = 'flex';

        // 重置标签页
        document.querySelectorAll('.table-tab').forEach((tab, index) => {
            tab.classList.remove('active');
            if (index === 0) tab.classList.add('active');
        });

        // 重置搜索
        document.getElementById('searchWorkloadInput').value = '';
        searchWorkloadData();
    }
}

// 为小组徽章添加CSS类
document.addEventListener('DOMContentLoaded', function() {
    // 确保小组徽章有正确的CSS类
    const style = document.createElement('style');
    style.textContent = `
        .badge-blue { background: rgba(59, 130, 246, 0.2); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); }
        .badge-green { background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3); }
        .badge-orange { background: rgba(245, 158, 11, 0.2); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.3); }
        .badge-gray { background: rgba(107, 114, 128, 0.2); color: #6b7280; border: 1px solid rgba(107, 114, 128, 0.3); }
        .group-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; }
        .trend-up { color: #10b981; }
        .trend-down { color: #ef4444; }
    `;
    document.head.appendChild(style);
});
</script>
{% endblock %}